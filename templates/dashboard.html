<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Whatnot Dashboard</title>
  <link rel="stylesheet" href="/static/dashboard_styles.css">
</head>
<body>

<div class="top-actions">
  <a href="/scan" class="scan-button">ğŸ“· Scan</a>
</div>

<h1>ğŸ“¦ Whatnot Orders Dashboard</h1>

<div class="packer-box">
  <h3>ğŸ‘¤ Select Active Packers</h3>
  <form method="POST" action="{{ url_for('set_active_packers') }}" class="custom-multi-dropdown">
    <div class="dropdown-box">
      <div class="dropdown-selected" onclick="toggleDropdown()" id="selectedText">
        {% if session.get('active_packers') %}
          {% set initials = [] %}
          {% for name in session.get('active_packers') %}
            {% set parts = name.split(' ') %}
            {% set initials = initials + [parts[0][0] ~ (parts[1][0] if parts|length > 1 else '')] %}
          {% endfor %}
          {{ initials | join(' + ') }}
        {% else %}
          Click to selectâ€¦
        {% endif %}
      </div>
      <div class="dropdown-list" id="dropdownList">
        {% for person in packer_names %}
          <label>
            <input type="checkbox" name="active_packers" value="{{ person }}"
              {% if person in session.get('active_packers', []) %}checked{% endif %}>
            {{ person }}
          </label>
        {% endfor %}
      </div>
    </div>
    <button type="submit">Save</button>
  </form>
</div>

<div class="summary-bar">
  Total Orders: <span>{{ total_orders }}</span>
  Packed: <span>{{ total_packed }}</span>
  Unpacked: <span>{{ total_unpacked }}</span>
</div>

<div class="upload-box">
  <h3>ğŸ“¥ Import CSV</h3>
  <form method="POST" enctype="multipart/form-data">
    <label for="csv_file">CSV File:</label>
    <input type="file" name="csv_file" id="csv_file" accept=".csv" required>

    <label for="show_date">Show Date:</label>
    <input type="date" name="show_date" id="show_date">

    <label for="show_label">Show Label:</label>
    <input type="text" name="show_label" id="show_label" placeholder="Ex: Morning Show">

    <button type="submit">Upload</button>
  </form>
</div>

<form method="GET" class="search-form">
  <input type="text" name="search" placeholder="Search by username or product" value="{{ query }}">
  <button type="submit">ğŸ” Search</button>
</form>

<form method="GET" class="show-filter">
  <label for="show">Filter by Show:</label>
  <select name="show" onchange="this.form.submit()">
    <option value="">-- All Shows --</option>
    {% for date, label in shows %}
      {% set value = date ~ '|' ~ label %}
      <option value="{{ value }}" {% if selected_show == value %}selected{% endif %}>
        {{ date }} - {{ label }}
      </option>
    {% endfor %}
  </select>
</form>

<div class="dashboard-container">
  {% for tracking, pkgs in grouped_packages.items() %}
    <div class="package-section {% if pkgs[0].tracking_number %}green{% else %}red{% endif %}">
      <div class="package-header" onclick="toggleDropdown(this)">
        <span class="tracking-info">
          {% if pkgs[0].tracking_number %}
            ğŸ“¦ {{ pkgs[0].tracking_number[-6:] }} - {{ pkgs[0].username }}
          {% else %}
            âŒ Missing USPS - {{ pkgs[0].username }}
          {% endif %}
        </span>
        <span class="status">
          {{ pkgs | selectattr('packed', 'equalto', true) | list | length }} Packed /
          {{ pkgs | selectattr('packed', 'equalto', false) | list | length }} Unpacked
        </span>
      </div>
      <div class="package-body">
        {% if pkgs[0].tracking_number %}
        <div class="package-actions">
          <form action="/upload/{{ pkgs[0].order_number }}" method="post" enctype="multipart/form-data">
            <input type="file" name="image" accept="image/*">
            <button class="upload-photo">ğŸ“¸ Upload Photos for Package</button>
          </form>
        </div>
        {% endif %}
        {% for pkg in pkgs %}
        <div class="package-item">
          <div><strong>ID#</strong>: {{ pkg.order_number }}</div>
          <div><strong>Product</strong>: {{ pkg.product_name }}</div>
          <a class="preview-label" href="{{ url_for('label', order_number=pkg.order_number) }}" target="_blank">ğŸ” Preview Label</a>
          <button class="toggle-packed {% if pkg.packed %}packed{% endif %}" onclick="togglePacked('{{ pkg.order_number }}', this)">
            {% if pkg.packed %}âœ… Packed{% else %}âŒ Unpacked{% endif %}
          </button>
          {% if not pkg.tracking_number %}
          <button class="add-usps" onclick="openUspsModal('{{ pkg.order_number }}')">â• Add USPS Number</button>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<!-- Modal for Adding USPS -->
<div id="uspsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeUspsModal()">&times;</span>
    <h3>Enter USPS Tracking Number</h3>
    <form onsubmit="submitUsps(event)">
      <input type="text" id="uspsInput" placeholder="Enter tracking number" required />
      <input type="hidden" id="targetOrderId" />
      <button type="submit">Save</button>
    </form>
  </div>
</div>
<script>
function toggleDropdown(headerEl) {
  const section = headerEl.closest('.package-section');
  const body = section.querySelector('.package-body');
  body.style.display = body.style.display === 'block' ? 'none' : 'block';
}

function togglePacked(orderId, btn) {
  fetch(`/toggle_packed/${orderId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      btn.classList.toggle('packed');
      btn.textContent = data.packed ? 'âœ… Packed' : 'âŒ Unpacked';
    } else {
      alert('Error updating packed status');
    }
  })
  .catch(() => alert('Failed to update packed status'));
}

function openUspsModal(orderId) {
  document.getElementById('uspsModal').style.display = 'block';
  document.getElementById('targetOrderId').value = orderId;
}

function closeUspsModal() {
  document.getElementById('uspsModal').style.display = 'none';
}

function submitUsps(e) {
  e.preventDefault();
  const tracking = document.getElementById('uspsInput').value;
  const orderId = document.getElementById('targetOrderId').value;

  fetch(`/update_tracking`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ order_id: orderId, tracking_number: tracking })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`Tracking number saved for order ${orderId}`);
      location.reload();
    } else {
      alert('Failed to save tracking number');
    }
  })
  .catch(() => alert('Server error'));
  closeUspsModal();
}
</script>
</body>
</html>