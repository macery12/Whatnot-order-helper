<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Whatnot Dashboard</title>
  <link rel="stylesheet" href="/static/dashboard_styles.css">
</head>
<body>

<div class="top-actions">
  <a href="/scan" class="scan-button">ğŸ“· Scan</a>
</div>


<h1>ğŸ“¦ Whatnot Orders Dashboard</h1>
<div class="header-controls"></div>
<div class="upload-box">
  <h3>ğŸ“¥ Import CSV</h3>
  <form method="POST" enctype="multipart/form-data">
    <label for="csv_file">CSV File:</label>
    <input type="file" name="csv_file" id="csv_file" accept=".csv" required>

    <label for="show_date">Show Date:</label>
    <input type="date" name="show_date" id="show_date">

    <label for="show_label">Show Label:</label>
    <input type="text" name="show_label" id="show_label" placeholder="Ex: Morning Show">

    <button type="submit">Upload</button>
  </form>
</div>

<div class="packer-box">
  <h3>ğŸ‘¤ Select Active Packer</h3>
  <form method="POST" action="{{ url_for('set_active_packers') }}">
    <select name="active_packers">
      <option value="">-- Select Packer --</option>
      {% for person in packer_names %}
        <option value="{{ person }}"
          {% if person in session.get('active_packers', []) %}selected{% endif %}>
          {{ person }}
        </option>
      {% endfor %}
    </select>
    <button type="submit">Save</button>
  </form>
</div>
</div>
<div class="summary-bar">
  Total Orders: <span>{{ total_orders }}</span>
  Packed: <span>{{ total_packed }}</span>
  Unpacked: <span>{{ total_unpacked }}</span>
</div>

<form method="GET" class="search-form">
  <input type="text" name="search" placeholder="Search by username or product" value="{{ query }}">
  <button type="submit">ğŸ” Search</button>
</form>

<form method="GET" class="show-filter">
  <label for="show">Filter by Show:</label>
  <select name="show" onchange="this.form.submit()">
    <option value="">-- All Shows --</option>
    {% for date, label in shows %}
      {% set value = date ~ '|' ~ label %}
      <option value="{{ value }}" {% if selected_show == value %}selected{% endif %}>
        {{ date }} - {{ label }}
      </option>
    {% endfor %}
  </select>
</form>

<div class="dashboard-container">
  {% for tracking, pkgs in grouped_packages.items() %}
    {% set all_packed = pkgs | selectattr('packed', 'equalto', true) | list | length == pkgs | length %}
    {% set any_missing_tracking = pkgs | selectattr('tracking_number', 'equalto', '') | list | length > 0 %}
    {% set section_class = 'green' if all_packed else ('red' if any_missing_tracking else 'yellow') %}
    
    <div class="package-section {{ section_class }}">
      <div class="package-header" onclick="toggleDropdown(this)">
        <span class="tracking-info">
          {% if pkgs[0].tracking_number %}
            ğŸ“¦ {{ pkgs[0].tracking_number[-6:] }} - {{ pkgs[0].username }}
          {% else %}
            âŒ Missing USPS - {{ pkgs[0].username }}
          {% endif %}
        </span>
        <span class="status">
          {{ pkgs | selectattr('packed', 'equalto', true) | list | length }} Packed /
          {{ pkgs | selectattr('packed', 'equalto', false) | list | length }} Unpacked
        </span>
      </div>
      
      <div class="package-body">
        {% if pkgs[0].tracking_number %}
        <div class="package-actions">
        <button class="upload-photo-camera" onclick="openCameraModal('{{ pkgs[0].order_number }}')">ğŸ“¸ Upload Photo</button>
      </div>
        {% endif %}
        
        {% for pkg in pkgs %}
        <div class="package-item">
          <div><strong>ID#</strong>: {{ pkg.order_number }}</div>
          <div><strong>Product</strong>: {{ pkg.product_name }}</div>

          {% if pkg.label_url %}
            <a href="{{ pkg.label_url }}" class="preview-label" target="_blank">ğŸ” Preview Label</a>
          {% endif %}

          <button class="toggle-packed {% if pkg.packed %}packed{% endif %}" onclick="togglePacked('{{ pkg.order_number }}', this)">
            {% if pkg.packed %}âœ… Packed{% else %}âŒ Unpacked{% endif %}
          </button>

          {% if not pkg.tracking_number %}
            <button class="add-usps" onclick="openUspsModal('{{ pkg.order_number }}')">â• Add USPS Number</button>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>


<!-- Modal for Adding USPS -->
<div id="uspsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeUspsModal()">&times;</span>
    <h3>Enter USPS Tracking Number</h3>
    <form onsubmit="submitUsps(event)">
      <input type="text" id="uspsInput" placeholder="Enter tracking number" required />
      <input type="hidden" id="targetOrderId" />
      <button type="submit">Save</button>
    </form>
  </div>
</div>
<div id="cameraModal" class="modal">
  <div class="modal-content" style="max-width: 360px;">
    <span class="close" onclick="closeCameraModal()">&times;</span>
    <h3>ğŸ“· Take Photo</h3>
    <video id="cameraStream" autoplay playsinline style="width: 100%; border-radius: 6px;"></video>
    <button class="upload-photo-camera" onclick="capturePhoto()">ğŸ“¸ Capture</button>
    <form id="cameraUploadForm" action="/upload/{{ pkgs[0].order_number }}" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="image" id="capturedImageInput">
    </form>
  </div>
</div>
<script>
function toggleDropdown(headerEl) {
  const section = headerEl.closest('.package-section');
  const body = section.querySelector('.package-body');
  body.style.display = body.style.display === 'block' ? 'none' : 'block';
}
function triggerCamera(button) {
  const form = button.closest('form');
  const input = form.querySelector('.hidden-camera-input');
  input.click();
}
function togglePacked(orderId, btn) {
  const isCurrentlyPacked = btn.classList.contains('packed');
  const newPackedState = !isCurrentlyPacked;

  fetch(`/api/toggle_packed`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order_number: orderId, packed: newPackedState })
  })
  .then(() => {
    btn.classList.toggle('packed', newPackedState);
    btn.textContent = newPackedState ? 'âœ… Packed' : 'âŒ Unpacked';
  })
  .catch(() => alert('Failed to update packed status'));
}


function openUspsModal(orderId) {
  document.getElementById('uspsModal').style.display = 'block';
  document.getElementById('targetOrderId').value = orderId;
}

function closeUspsModal() {
  document.getElementById('uspsModal').style.display = 'none';
}

function submitUsps(e) {
  e.preventDefault();
  const tracking = document.getElementById('uspsInput').value;
  const orderId = document.getElementById('targetOrderId').value;

  fetch(`/update_tracking`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ order_id: orderId, tracking_number: tracking })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`Tracking number saved for order ${orderId}`);
      location.reload();
    } else {
      alert('Failed to save tracking number');
    }
  })
  .catch(() => alert('Server error'));
  closeUspsModal();
}





let cameraStream = null;
const video = document.getElementById('cameraStream');

function openCameraModal(orderNumber) {
  const modal = document.getElementById('cameraModal');
  modal.style.display = 'block';

  const form = document.getElementById('cameraUploadForm');
  form.action = `/upload/${orderNumber}`;

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      cameraStream = stream;
      video.srcObject = stream;
    })
    .catch(() => alert('Unable to access camera'));
}

function closeCameraModal() {
  const modal = document.getElementById('cameraModal');
  modal.style.display = 'none';

  if (cameraStream) {
    const tracks = cameraStream.getTracks();
    tracks.forEach(track => track.stop());
    cameraStream = null;
  }
}

function capturePhoto() {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);

  const imageData = canvas.toDataURL('image/jpeg');
  const input = document.getElementById('capturedImageInput');
  input.value = imageData;

  document.getElementById('cameraUploadForm').submit();
}

</script>
</body>
</html>